<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infographic: The Simulation Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .flow-arrow::after {
            content: '▼';
            font-size: 2rem;
            color: #58508d;
            line-height: 1;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .flow-arrow-horizontal {
            position: relative;
            flex-grow: 1;
            height: 2px;
            background-color: #58508d;
            margin: 0 1rem;
        }
        .flow-arrow-horizontal::after {
            content: '►';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #58508d;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .input-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .input-card input {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            width: 100%;
            border: none;
            padding: 0;
            margin-top: 0.25rem;
            background-color: transparent;
        }
        .input-card input:focus {
            outline: none;
            ring: 0;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            height: 50vh;
            max-height: 500px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-[#003f5c]">The Simulation Engine</h1>
            <p class="text-xl text-gray-600 mt-2">A Visual Guide to How Your Retirement Future is Calculated</p>
        </header>

        <section id="setup" class="mb-12">
            <div class="text-center max-w-5xl mx-auto">
                <h2 class="text-3xl font-bold text-[#58508d] mb-4">1. The Starting Point: Your Financial DNA</h2>
                <p class="text-lg text-gray-700 mb-8">The simulation begins with your unique parameters. Change any value below and run the simulation to see how it impacts your 10-year outlook.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="input-card border-t-4 border-[#003f5c]">
                        <label for="initialPortfolioValue" class="text-sm font-semibold text-gray-500">PORTFOLIO VALUE ($)</label>
                        <input type="number" id="initialPortfolioValue" value="1000000" class="text-[#003f5c]">
                    </div>
                    <div class="input-card border-t-4 border-[#003f5c]">
                         <label for="initialCostBasis" class="text-sm font-semibold text-gray-500">COST BASIS ($)</label>
                         <input type="number" id="initialCostBasis" value="700000" class="text-[#003f5c]">
                    </div>
                    <div class="input-card border-t-4 border-[#bc5090]">
                        <label for="annualSpending" class="text-sm font-semibold text-gray-500">ANNUAL SPENDING ($)</label>
                        <input type="number" id="annualSpending" value="120000" class="text-[#bc5090]">
                    </div>
                    <div class="input-card border-t-4 border-[#ff6361]">
                        <label for="annualReturn" class="text-sm font-semibold text-gray-500">AVG. ANNUAL RETURN (%)</label>
                        <input type="number" id="annualReturn" value="10" class="text-[#ff6361]">
                    </div>
                    <div class="input-card border-t-4 border-[#ff6361]">
                        <label for="annualStdDev" class="text-sm font-semibold text-gray-500">ANNUAL STD. DEV. (%)</label>
                        <input type="number" id="annualStdDev" value="19" class="text-[#ff6361]">
                    </div>
                    <div class="input-card border-t-4 border-[#ffa600]">
                        <label for="marginRate" class="text-sm font-semibold text-gray-500">AVG. MARGIN RATE (%)</label>
                        <input type="number" id="marginRate" value="5" class="text-[#ffa600]">
                    </div>
                    <div class="input-card border-t-4 border-[#ffa600]">
                         <label for="marginRateStdDev" class="text-sm font-semibold text-gray-500">MARGIN STD. DEV. (%)</label>
                         <input type="number" id="marginRateStdDev" value="1.5" class="text-[#ffa600]">
                    </div>
                     <div class="input-card border-t-4 border-[#ff6361]">
                        <label for="marginLimit" class="text-sm font-semibold text-gray-500">MARGIN BORROW LIMIT (%)</label>
                        <input type="number" id="marginLimit" value="50" class="text-[#ff6361]">
                    </div>
                    <div class="input-card border-t-4 border-[#58508d]">
                        <label for="simulationCount" class="text-sm font-semibold text-gray-500"># OF SIMULATIONS</label>
                        <input type="number" id="simulationCount" value="200" class="text-[#58508d]">
                    </div>
                </div>
                 <div class="mt-8 text-center">
                    <button id="runButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Run Simulation</button>
                </div>
            </div>
        </section>

        <section id="monthly-cycle" class="mb-16">
            <div class="text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-[#58508d] mb-4">2. The Monthly Cycle: The Engine's Core</h2>
                <p class="text-lg text-gray-700">For 120 months, each simulation runs through a precise sequence of events. This is the heart of the model, where market chances meet your financial plan month after month.</p>
            </div>
            <div class="mt-10 flex flex-col items-center">
                <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md text-center">
                    <span class="text-xs font-bold text-white bg-[#003f5c] py-1 px-3 rounded-full">STEP 1</span>
                    <h3 class="text-xl font-semibold mt-2">Market Moves & Dividends</h3>
                    <p class="text-gray-600 mt-2 text-sm">A random market return is generated and applied to your portfolio. Every 3 months, dividends are paid out and used to reduce your margin loan.</p>
                </div>
                <div class="flow-arrow"></div>
                <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md text-center">
                    <span class="text-xs font-bold text-white bg-[#003f5c] py-1 px-3 rounded-full">STEP 2</span>
                    <h3 class="text-xl font-semibold mt-2">Covering Expenses</h3>
                    <p class="text-gray-600 mt-2 text-sm">Your monthly spending is funded first by passive income. Any shortfall is covered by borrowing more on margin, increasing your loan balance.</p>
                </div>
                <div class="flow-arrow"></div>
                <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md text-center border-4 border-transparent ring-4 ring-red-200">
                     <span class="text-xs font-bold text-white bg-[#ff6361] py-1 px-3 rounded-full">STEP 3</span>
                    <h3 class="text-xl font-semibold mt-2 text-[#ff6361]">Risk Check: Margin Call</h3>
                    <p class="text-gray-600 mt-2 text-sm">We check if your loan has exceeded your specified limit (e.g., 50%) of your portfolio's value. If so, a forced sale occurs, selling the exact amount of stock needed to bring the loan back to the limit. This deleverages the portfolio but realizes gains.</p>
                </div>
            </div>
        </section>

        <section id="annual-reset" class="mb-16">
            <div class="text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-[#58508d] mb-4">3. The Annual Reset: Tax & Strategy</h2>
                <p class="text-lg text-gray-700">At the end of each simulated year, a critical series of financial maneuvers takes place. This is where your tax strategy is executed to optimize your portfolio for the year ahead.</p>
            </div>
            <div class="mt-10 flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="bg-white p-5 rounded-xl shadow-lg flex-1 max-w-sm text-center">
                    <span class="text-xs font-bold text-white bg-[#bc5090] py-1 px-3 rounded-full">YEAR-END 1</span>
                    <h3 class="text-lg font-semibold mt-2">Tax-Gain Harvesting</h3>
                    <p class="text-gray-600 mt-2 text-sm">If your long-term unrealized gains are above 30%, we sell just enough stock to realize gains up to your $123,250 federal tax-free limit. The cash is used to buy back the stock immediately, raising your cost basis ("step-up") and reducing future taxes.</p>
                </div>
                <div class="items-center justify-center hidden md:flex">
                    <div class="flow-arrow-horizontal"></div>
                </div>
                 <div class="flex md:hidden flow-arrow"></div>
                <div class="bg-white p-5 rounded-xl shadow-lg flex-1 max-w-sm text-center">
                     <span class="text-xs font-bold text-white bg-[#bc5090] py-1 px-3 rounded-full">YEAR-END 2</span>
                    <h3 class="text-lg font-semibold mt-2">State Tax Calculation</h3>
                    <p class="text-gray-600 mt-2 text-sm">We calculate your California state tax. Your investment income (dividends + harvested gains) is offset by the margin interest you paid. The final tax bill is added to your margin loan balance for the new year.</p>
                </div>
            </div>
        </section>
        
        <section id="final-verdict" class="mb-8 hidden">
             <div class="text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-[#58508d] mb-4">4. The Final Verdict: Your Simulated Future</h2>
                <p class="text-lg text-gray-700">After running the simulations, the results below show the range of possibilities for your net worth. The simulation stops if the average outcome (the dark blue line) drops below zero.</p>
            </div>
            <div id="loadingIndicator" class="hidden justify-center items-center my-8 flex-col">
                <div class="loader"></div>
                <p class="mt-4 text-gray-600">Running simulations...</p>
            </div>
            <div id="resultsContent" class="hidden">
                 <div id="summaryBox" class="text-center p-6 rounded-2xl shadow-lg my-8 max-w-3xl mx-auto"></div>
                <div class="mt-10 bg-white p-6 rounded-2xl shadow-lg">
                    <div class="chart-container">
                        <canvas id="summaryChart"></canvas>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="analyzeButton" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:bg-gray-400" disabled>✨ Analyze Results</button>
                </div>
                <div id="aiAnalysisSection" class="mt-8 max-w-3xl mx-auto hidden">
                     <div id="aiLoadingIndicator" class="hidden justify-center items-center my-8 flex-col">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-600">Gemini is analyzing the results...</p>
                    </div>
                    <div id="aiResult" class="bg-white p-6 rounded-2xl shadow-lg prose"></div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg mt-8">
                    <h3 class="text-xl font-semibold text-gray-700 text-center mb-4">Monthly Data</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Net Worth ($)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Net Worth ($)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Net Worth ($)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

<script>
    let summaryChart = null;
    let lastResults = {};

    function randomNormal(mean, stdDev) {
        let u1 = 0, u2 = 0;
        while (u1 === 0) u1 = Math.random();
        while (u2 === 0) u2 = Math.random();
        const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
        return z * stdDev + mean;
    }

    function calculateCaTax(taxableIncome) {
        const brackets = [
            { limit: 21512, rate: 0.01 }, { limit: 50998, rate: 0.02 },
            { limit: 80490, rate: 0.04 }, { limit: 111732, rate: 0.06 },
            { limit: 141212, rate: 0.08 }, { limit: 721318, rate: 0.093 },
            { limit: 865574, rate: 0.103 }, { limit: 1442628, rate: 0.113 },
            { limit: Infinity, rate: 0.123 },
        ];
        let tax = 0;
        let lastLimit = 0;
        if (taxableIncome <= 0) return 0;
        for (const bracket of brackets) {
            if (taxableIncome > lastLimit) {
                const taxableInBracket = Math.min(taxableIncome - lastLimit, bracket.limit - lastLimit);
                tax += taxableInBracket * bracket.rate;
            }
            lastLimit = bracket.limit;
        }
        return tax;
    }

    async function runSimulation() {
        document.getElementById('runButton').disabled = true;
        document.getElementById('runButton').textContent = 'Running...';
        document.getElementById('final-verdict').classList.remove('hidden');
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('loadingIndicator').classList.add('flex');
        document.getElementById('resultsContent').classList.add('hidden');
        document.getElementById('aiAnalysisSection').classList.add('hidden');
        document.getElementById('analyzeButton').disabled = true;
        
        await new Promise(resolve => setTimeout(resolve, 100));

        const inputs = {
            initialPortfolioValue: parseFloat(document.getElementById('initialPortfolioValue').value),
            initialCostBasis: parseFloat(document.getElementById('initialCostBasis').value),
            annualSpending: parseFloat(document.getElementById('annualSpending').value),
            monthlyPassiveIncome: 1000,
            annualReturn: parseFloat(document.getElementById('annualReturn').value) / 100,
            annualStdDev: parseFloat(document.getElementById('annualStdDev').value) / 100,
            annualDividendYield: 0.01,
            marginRate: parseFloat(document.getElementById('marginRate').value) / 100,
            marginRateStdDev: parseFloat(document.getElementById('marginRateStdDev').value) / 100,
            marginLimit: parseFloat(document.getElementById('marginLimit').value) / 100,
            federalTaxFreeLimit: 123250,
            harvestThreshold: 0.30,
            simulationCount: parseInt(document.getElementById('simulationCount').value),
        };
        
        const monthlySpending = inputs.annualSpending / 12;
        const monthlyReturn = Math.pow(1 + inputs.annualReturn, 1/12) - 1;
        const monthlyStdDev = inputs.annualStdDev / Math.sqrt(12);
        const quarterlyDividendYield = inputs.annualDividendYield / 4;
        const caStandardDeduction = 11080; 

        let allSimulationsNetWorth = Array.from({ length: 120 }, () => []);

        for (let i = 0; i < inputs.simulationCount; i++) {
            let long_term_value = inputs.initialPortfolioValue;
            let long_term_basis = inputs.initialCostBasis;
            let short_term_values = Array(12).fill(0);
            let short_term_bases = Array(12).fill(0);
            let margin_loan = 0;
            let current_annual_margin_rate = randomNormal(inputs.marginRate, inputs.marginRateStdDev);
            let total_margin_interest_paid_this_year = 0;
            let gains_realized_this_year = 0;
            let total_dividend_income_this_year = 0;

            for (let month = 1; month <= 120; month++) {
                const aging_value = short_term_values.shift();
                const aging_basis = short_term_bases.shift();
                short_term_values.push(0);
                short_term_bases.push(0);
                long_term_value += aging_value;
                long_term_basis += aging_basis;

                const randomMonthlyReturn = randomNormal(monthlyReturn, monthlyStdDev);
                long_term_value *= (1 + randomMonthlyReturn);
                short_term_values = short_term_values.map(v => v * (1 + randomMonthlyReturn));

                let totalPortfolioValue = long_term_value + short_term_values.reduce((a, b) => a + b, 0);

                if (month % 3 === 0) {
                    const dividend_payment = totalPortfolioValue * quarterlyDividendYield;
                    margin_loan -= dividend_payment;
                    total_dividend_income_this_year += dividend_payment;
                }
                
                const cash_shortfall = monthlySpending - inputs.monthlyPassiveIncome;
                margin_loan += cash_shortfall;
                
                const monthlyMarginInterest = margin_loan * (current_annual_margin_rate / 12);
                margin_loan += monthlyMarginInterest;
                total_margin_interest_paid_this_year += monthlyMarginInterest;
                
                totalPortfolioValue = long_term_value + short_term_values.reduce((a, b) => a + b, 0);
                const margin_limit_value = totalPortfolioValue * inputs.marginLimit;

                if (margin_loan > margin_limit_value) {
                    const amount_to_sell = (margin_loan - margin_limit_value) / (1 - inputs.marginLimit);
                    
                    if (amount_to_sell > 0) {
                        let sold_from_lt = Math.min(amount_to_sell, long_term_value);
                        if(long_term_value > 0){
                           const lt_unrealized_gain_pct = (long_term_value - long_term_basis) / long_term_value;
                           const gain_from_lt_sale = sold_from_lt * (lt_unrealized_gain_pct > 0 ? lt_unrealized_gain_pct : 0);
                           const basis_from_lt_sale = sold_from_lt - gain_from_lt_sale;
                           long_term_value -= sold_from_lt;
                           long_term_basis -= basis_from_lt_sale;
                           gains_realized_this_year += gain_from_lt_sale;
                        }
                    }
                }

                if (month % 12 === 0) {
                    if (long_term_value > 0) {
                        const lt_unrealized_gain_pct = (long_term_value - long_term_basis) / long_term_value;
                        if (lt_unrealized_gain_pct > inputs.harvestThreshold) {
                            const total_investment_income_so_far = gains_realized_this_year + total_dividend_income_this_year;
                            let gains_to_harvest = inputs.federalTaxFreeLimit - total_investment_income_so_far;

                            if (gains_to_harvest > 0 && lt_unrealized_gain_pct > 0) {
                                const value_to_harvest = Math.min(long_term_value, gains_to_harvest / lt_unrealized_gain_pct);
                                const actual_gains_harvested = value_to_harvest * lt_unrealized_gain_pct;
                                const basis_of_harvested = value_to_harvest - actual_gains_harvested;
                                long_term_value -= value_to_harvest;
                                long_term_basis -= basis_of_harvested;
                                short_term_values[11] += value_to_harvest;
                                short_term_bases[11] += value_to_harvest;
                                gains_realized_this_year += actual_gains_harvested;
                            }
                        }
                    }

                    const total_investment_income = gains_realized_this_year + total_dividend_income_this_year;
                    const net_investment_income = total_investment_income - total_margin_interest_paid_this_year;
                    const ca_taxable_income = net_investment_income + (inputs.monthlyPassiveIncome * 12) - caStandardDeduction;
                    const ca_tax_due = calculateCaTax(ca_taxable_income);
                    margin_loan += ca_tax_due;

                    current_annual_margin_rate = randomNormal(inputs.marginRate, inputs.marginRateStdDev);
                    gains_realized_this_year = 0;
                    total_margin_interest_paid_this_year = 0;
                    total_dividend_income_this_year = 0;
                }
                
                const finalPortfolioValue = long_term_value + short_term_values.reduce((a, b) => a + b, 0);
                const netWorth = finalPortfolioValue - margin_loan;
                allSimulationsNetWorth[month - 1].push(netWorth);
            }
        }
        
        const aggregatedResults = allSimulationsNetWorth.map(monthlyData => {
            const sorted = [...monthlyData].sort((a, b) => a - b);
            const sum = sorted.reduce((a, b) => a + b, 0);
            return {
                min: sorted[0],
                avg: sum / sorted.length,
                max: sorted[sorted.length - 1],
            };
        });

        let stopMonth = -1;
        for (let i = 0; i < aggregatedResults.length; i++) {
            if (aggregatedResults[i].avg < 0) {
                stopMonth = i + 1;
                break;
            }
        }
        
        lastResults = {
            inputs: inputs,
            results: aggregatedResults,
            stopMonth: stopMonth,
        };
        displayResults(aggregatedResults, stopMonth);
    }
    
    function displayResults(results, stopMonth) {
        const summaryBox = document.getElementById('summaryBox');
        if (stopMonth !== -1) {
            summaryBox.innerHTML = `<h2 class="text-2xl font-bold text-red-600">Strategy Failed</h2><p class="text-gray-600 mt-2">The average net worth dropped below zero in month ${stopMonth}.</p>`;
            summaryBox.className = 'text-center p-6 rounded-2xl shadow-lg my-8 max-w-3xl mx-auto bg-red-100';
        } else {
            const finalAvg = results[results.length - 1].avg;
            summaryBox.innerHTML = `<h2 class="text-2xl font-bold text-green-600">Strategy Survived 10 Years</h2><p class="text-gray-600 mt-2">The average net worth after 10 years is <strong>$${finalAvg.toLocaleString('en-US', {maximumFractionDigits: 0})}</strong>.</p>`;
            summaryBox.className = 'text-center p-6 rounded-2xl shadow-lg my-8 max-w-3xl mx-auto bg-green-100';
        }

        const tableBody = document.getElementById('resultsTableBody');
        tableBody.innerHTML = '';
        results.forEach((data, index) => {
            const row = `<tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${Math.round(data.min).toLocaleString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${Math.round(data.avg).toLocaleString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${Math.round(data.max).toLocaleString()}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        const ctx = document.getElementById('summaryChart').getContext('2d');
        const labels = Array.from({ length: 120 }, (_, i) => i + 1);
        if (summaryChart) {
            summaryChart.destroy();
        }
        summaryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Min Net Worth', data: results.map(d => d.min), borderColor: '#ff6361', borderWidth: 2, fill: false, pointRadius: 0,
                    },
                    {
                        label: 'Average Net Worth', data: results.map(d => d.avg), borderColor: '#003f5c', backgroundColor: 'rgba(88, 80, 141, 0.1)', borderWidth: 3, fill: '+1', pointRadius: 0,
                    },
                    {
                        label: 'Max Net Worth', data: results.map(d => d.max), borderColor: '#ffa600', backgroundColor: 'rgba(88, 80, 141, 0.1)', borderWidth: 2, fill: false, pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { ticks: { callback: (value) => '$' + (value / 1000) + 'k' } },
                    x: { title: { display: true, text: 'Month' } }
                },
                plugins: {
                    tooltip: {
                         callbacks: {
                            title: (tooltipItems) => {
                                const item = tooltipItems[0];
                                let label = item.chart.data.labels[item.dataIndex];
                                return Array.isArray(label) ? label.join(' ') : "Month: " + label;
                            },
                             label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('loadingIndicator').classList.remove('flex');
        document.getElementById('resultsContent').classList.remove('hidden');
        document.getElementById('runButton').disabled = false;
        document.getElementById('runButton').textContent = 'Run Simulation';
        document.getElementById('analyzeButton').disabled = false;
    }
    
    async function getAiAnalysis() {
        if (!lastResults.results) return;

        document.getElementById('analyzeButton').disabled = true;
        document.getElementById('analyzeButton').textContent = '✨ Analyzing...';
        document.getElementById('aiAnalysisSection').classList.remove('hidden');
        document.getElementById('aiLoadingIndicator').classList.remove('hidden');
        document.getElementById('aiLoadingIndicator').classList.add('flex');
        document.getElementById('aiResult').classList.add('hidden');

        const { inputs, results, stopMonth } = lastResults;
        const succeeded = stopMonth === -1;
        const finalAvg = succeeded ? results[results.length - 1].avg : 0;
        const finalMin = succeeded ? results[results.length - 1].min : 0;
        const finalMax = succeeded ? results[results.length - 1].max : 0;

        const systemPrompt = "You are a helpful financial analyst assistant. Your role is to provide a clear, concise, and neutral interpretation of Monte Carlo simulation results for a retirement plan. Do not give financial advice. Do not use overly optimistic or pessimistic language. Stick to interpreting the data provided. Start your analysis with a one-sentence summary of the outcome. Then, explain the key factors influencing the result. Structure your response in two paragraphs.";

        const userQuery = `Here are the results of a 10-year retirement simulation. Please provide a brief analysis.

        Key Inputs:
        - Initial Portfolio: $${inputs.initialPortfolioValue.toLocaleString()}
        - Annual Spending: $${inputs.annualSpending.toLocaleString()}
        - Portfolio Avg. Annual Return: ${inputs.annualReturn * 100}% (Std. Dev: ${inputs.annualStdDev * 100}%)
        - Strategy: Living on margin (up to ${inputs.marginLimit * 100}% of portfolio value) with annual tax-gain harvesting.

        Simulation Outcome (${inputs.simulationCount} runs):
        - Success Status: ${succeeded ? 'Survived 10 years' : `Failed at month ${stopMonth}`}
        - Final Average Net Worth: $${Math.round(finalAvg).toLocaleString()}
        - Final Minimum Net Worth: $${Math.round(finalMin).toLocaleString()}
        - Final Maximum Net Worth: $${Math.round(finalMax).toLocaleString()}

        Based on this data, please provide your analysis.`;

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, the analysis could not be generated at this time.";
            
            document.getElementById('aiResult').innerHTML = analysisText.replace(/\n/g, '<br>');

        } catch (error) {
            console.error("Gemini API Error:", error);
            document.getElementById('aiResult').innerHTML = "An error occurred while fetching the analysis. Please check the console for details.";
        } finally {
            document.getElementById('aiLoadingIndicator').classList.add('hidden');
            document.getElementById('aiLoadingIndicator').classList.remove('flex');
            document.getElementById('aiResult').classList.remove('hidden');
            document.getElementById('analyzeButton').disabled = false;
            document.getElementById('analyzeButton').textContent = '✨ Analyze Results';
        }
    }

    document.getElementById('runButton').addEventListener('click', runSimulation);
    document.getElementById('analyzeButton').addEventListener('click', getAiAnalysis);
</script>

</body>
</html>